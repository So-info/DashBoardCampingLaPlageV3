<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <title>Camping ‚Äì Interventions</title>

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' }
          },
          borderRadius: { xl: '18px', '2xl':'22px' },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' },
          keyframes: {
            pop: { from:{opacity:0,transform:'translateY(4px)'}, to:{opacity:1,transform:'none'} },
            shimmer:{ '100%':{ transform:'translateX(100%)' } }
          },
          animation: { pop: 'pop .15s ease-out', shimmer:'shimmer 1.2s infinite' }
        }
      }
    }
  </script>

  <style>
    :root{
      --bg:#f8fafc; --bg-2:#ffffff; --panel:#ffffff; --muted:#f1f5f9; --line:#e5e7eb;
      --text:#0f172a; --text-dim:#64748b; --accent:#2563eb; --accent-2:#16a34a; --danger:#dc2626;
      --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
      --safe-top:env(safe-area-inset-top); --safe-bottom:env(safe-area-inset-bottom);
    }
    html,body{height:100%}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; font-size:clamp(14px,2.4vw,16px); line-height:1.45; color:var(--text); background:var(--bg); padding-top:var(--safe-top); padding-bottom:var(--safe-bottom) }

    .topbar{ position:sticky; top:0; z-index:20; background:rgba(255,255,255,.85); backdrop-filter:blur(10px); border-bottom:1px solid var(--line) }
    .chip{ display:inline-flex; align-items:center; gap:6px; font-size:.75rem; color:#334155; background:var(--muted); border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-weight:700 }

    .panel{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); position:relative; overflow:hidden }
    .panel::after{ content:""; position:absolute; inset:-2px; border-radius:calc(var(--radius) + 2px); padding:2px; background:linear-gradient(120deg,transparent, rgba(37,99,235,.25), transparent); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none }

    /* Board */
    .board-col{background:#fff;border:1px solid #eef2f7;border-radius:18px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.04)}
    .col-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .col-title{font-size:.72rem;letter-spacing:.12em;text-transform:uppercase;color:#64748b;font-weight:800}
    .col-count{font-size:.72rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:.15rem .5rem;font-weight:800;color:#334155}

    .task-card{ position:relative; border:1px solid #e5e7eb; border-radius:16px; background:#fff; padding:12px 14px; box-shadow:0 6px 14px rgba(15,23,42,.04); transition:transform .08s ease, box-shadow .2s ease, border-color .2s }
    .task-card:hover{ transform:translateY(-1px); box-shadow:0 14px 26px rgba(15,23,42,.09) }
    .task-card::before{ content:""; position:absolute; left:-1px; top:-1px; bottom:-1px; width:6px; border-radius:16px 0 0 16px; background:#cbd5e1 }
    .bar-urgent::before{ background:#ef4444 } .bar-haute::before{ background:#f59e0b } .bar-normale::before{ background:#94a3b8 }
    .task-title{font-weight:800;color:#0f172a}
    .task-meta{font-size:.78rem;color:#64748b;margin-top:2px}

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:.78rem;font-weight:800;border:1px solid #e2e8f0;background:#f1f5f9;color:#334155}
    .pill.amber{background:#fffbeb;color:#92400e;border-color:#f59e0b}
    .pill.red{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .pill.gray{background:#f1f5f9;color:#334155;border-color:#e2e8f0}

    .empty{display:grid;place-items:center;height:80px;border:2px dashed var(--line);border-radius:14px;color:#94a3b8;font-weight:700;background:#fafafa}

    #toastRoot{ position:fixed; right:14px; bottom:14px; display:grid; gap:8px; z-index:60 }
    .toast{display:flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:12px;color:#fff;box-shadow:0 12px 28px rgba(0,0,0,.2);background:#065f46;font-weight:700}
    .toast.err{background:#7f1d1d}

    /* --- Mobile polish --- */
@media (max-width: 767px){
  .topbar .max-w-6xl{ padding-left:14px; padding-right:14px }
  .topbar h1{ display:none }                /* cache le gros titre sur mobile */
  .chip{ padding:6px 9px }                  /* puces un poil plus compactes */
  .panel{ border-radius:16px }

  /* Filtres collants sous la topbar */
  .filters-sticky{ position:sticky; top:52px; z-index:15; }

  /* Accord√©on des colonnes */
  .mobile-col{ padding:10px 12px; border-radius:16px }
  .mobile-col .col-head{ margin:-6px -6px 6px; padding:6px; border-radius:12px; }
  .mobile-col .col-head button{ width:100%; display:flex; align-items:center; justify-content:space-between }
  .mobile-col .col-body{ display:none }
  .mobile-col.open .col-body{ display:grid }
  .mobile-col .col-title{ font-size:.7rem; letter-spacing:.12em }
  .mobile-col .col-count{ transform:translateY(-1px) }

  /* cartes plus denses mais cliquables */
  .task-card{ padding:10px 12px; border-radius:14px }
  .task-card::before{ border-radius:14px 0 0 14px }

  /* bouton + flottant (visible seulement mobile) */
  .fab{
    position:fixed; right:16px; bottom:calc(16px + var(--safe-bottom));
    width:56px; height:56px; border-radius:999px;
    display:grid; place-items:center;
    font-size:24px; line-height:1; font-weight:800;
    color:#fff; background:#4f46e5; box-shadow:0 18px 40px rgba(79,70,229,.35);
    z-index:45;
  }
}

/* petit luxe : vignette de ‚Äúsquelette‚Äù plus fine */
.empty{ height:64px }

  </style>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèïÔ∏è</text></svg>">
</head>
<body>
  <!-- Toast root -->
  <div id="toastRoot" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
<!-- APR√àS -->
<header id="headerRoot" class="topbar hidden">
    <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo-la-plage.png" alt="Camping La Plage" class="h-8 sm:h-9 w-auto" onerror="this.remove();document.getElementById('logoFallback').classList.remove('hidden')" />
        <span id="logoFallback" class="text-2xl hidden">üèïÔ∏è</span>
<h1 class="hidden sm:block text-xl font-semibold tracking-tight text-primary-700">
  Dashboard ‚Äì Interventions
</h1>

        <span id="envBadge" class="hidden ml-3 text-xs px-2 py-1 rounded-full bg-primary-50 text-primary-700">D√©mo</span>
      </div>
      <div class="flex items-center gap-3">
        <span id="userRole" class="hidden sm:inline chip">R√¥le : <strong class="font-extrabold">‚Äî</strong></span>
        <button id="logoutBtn" class="hidden border border-[var(--line)] text-[var(--text-dim)] rounded-xl px-3 py-2 bg-white">Se d√©connecter</button>
      </div>
    </div>

    <!-- Barre de service visible pour R√©ception/Responsable (pages s√©par√©es) -->
    <div id="serviceBar" class="hidden border-t">
      <div class="max-w-6xl mx-auto px-6 py-2 flex items-center gap-2">
        <div class="text-xs font-semibold text-gray-600">Pages¬†:</div>
        <div class="inline-flex gap-2">
          <a href="#technique" data-service="Technique" class="svc-btn px-3 py-1.5 rounded-full text-sm font-semibold border border-[var(--line)] bg-white">Technique</a>
          <a href="#menage"    data-service="Menage"    class="svc-btn px-3 py-1.5 rounded-full text-sm font-semibold border border-[var(--line)] bg-white">M√©nage</a>
          <a href="#affectations" data-service="ALL"   class="svc-btn px-3 py-1.5 rounded-full text-sm font-semibold border border-[var(--line)] bg-white">Affectations (toutes)</a>
        </div>
        <span class="ml-auto text-xs text-gray-500">Partagez l‚ÄôURL √† l‚Äô√©quipe¬†: elle ne verra que sa page.</span>
      </div>
    </div>
  </header>

  <!-- Auth view -->
<!-- APR√àS -->
<main id="authView" class="min-h-screen grid place-items-center px-4">

    <section class="panel p-6 sm:p-8 w-full max-w-md">
      <header class="flex items-center gap-3 mb-3">
        <img class="h-12 sm:h-16 object-contain" src="logo-la-plage.png" alt="Camping La Plage" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'üèïÔ∏è',className:'text-5xl select-none'}))" />
        <div>
          <h2 class="text-2xl font-semibold tracking-tight">Connexion</h2>
          <p class="text-[var(--text-dim)] text-sm">Entrez vos identifiants pour acc√©der au dashboard.</p>
        </div>
      </header>

      <form id="loginForm" class="grid gap-4">
        <div>
          <label class="block text-sm text-[var(--text-dim)] mb-1">Email</label>
          <input id="email" type="email" required class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500" placeholder="ex: rec01@demo.local" />
        </div>
        <div>
          <label class="block text-sm text-[var(--text-dim)] mb-1">Mot de passe</label>
          <input id="password" type="password" required class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="flex items-center justify-between">
          <span id="authError" class="text-sm text-red-700"></span>
          <button class="px-4 py-3 rounded-xl bg-primary-600 text-white font-semibold hover:bg-primary-700 shadow-md">Se connecter</button>
        </div>
      </form>

      <div class="my-5 h-px bg-[var(--line)]"></div>

      <button id="googleBtn" class="w-full flex items-center justify-center gap-3 border border-[var(--line)] rounded-xl py-3 hover:bg-gray-50">
        <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" />
        <span class="font-medium text-gray-700">Continuer avec Google</span>
      </button>
    </section>
  </main>
<button id="fabNew" class="md:hidden fab" aria-label="Nouvelle intervention">+</button>

  <!-- App view -->
  <main id="appView" class="hidden max-w-6xl mx-auto px-6 py-6 flex flex-col gap-6">

    <!-- Tabs (renomm√©) -->
    <nav id="tabs" class="hidden">
      <div class="inline-flex rounded-full bg-[var(--muted)] p-1 border border-[var(--line)] shadow-sm">
        <button data-tab="tasks" class="tab-btn px-5 py-2 rounded-full text-sm font-semibold bg-white shadow">Interventions</button>
        <button data-tab="accounts" class="tab-btn px-5 py-2 rounded-full text-sm font-semibold text-gray-600 hover:text-gray-900">Comptes</button>
      </div>
    </nav>

    <!-- Filtres -->
<section class="panel p-4 md:p-6 filters-sticky" id="filtersPanel">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4 items-center">
        <select id="teamFilter" class="px-4 py-3 rounded-xl border border-[var(--line)] bg-white font-medium focus:ring-2 focus:ring-primary-300 focus:border-primary-500">
          <option value="ALL">Tous les services</option>
          <option value="Technique">Technique</option>
          <option value="Menage">M√©nage</option>
        </select>
        <select id="statusFilter" class="px-4 py-3 rounded-xl border border-[var(--line)] bg-white font-medium focus:ring-2 focus:ring-primary-300 focus:border-primary-500">
          <option value="ACTIVE">Statuts actifs</option>
          <option value="A_faire">√Ä faire</option>
          <option value="En_cours">En cours</option>
          <option value="Bloque">Bloqu√©</option>
          <option value="Termine">Termin√©</option>
        </select>
        <input id="searchInput" type="search" placeholder="Rechercher une intervention‚Ä¶" class="px-4 py-3 rounded-xl border border-[var(--line)] focus:ring-2 focus:ring-primary-300 focus:border-primary-500 font-medium" />
        <div class="flex md:justify-end">
          <button id="newTaskBtn" class="w-full md:w-auto px-6 py-3 rounded-xl bg-primary-600 text-white font-semibold hover:bg-primary-700 shadow-md">+ Nouvelle intervention</button>
        </div>
      </div>
      <div id="serviceHint" class="hidden text-xs text-gray-500 mt-2">Vue filtr√©e¬†: <span class="font-semibold" id="serviceHintLabel"></span></div>
    </section>

    <!-- Board -->
    <section id="boardWrapper" class="grid md:grid-cols-4 md:gap-6">
      <div id="board" class="contents"></div>
    </section>

    <!-- Accounts -->
    <section id="accountsView" class="hidden panel p-6">
      <h3 class="font-semibold text-lg mb-2">Gestion des comptes</h3>
      <p class="text-xs text-[var(--text-dim)] mb-4">Attribuez un r√¥le aux salari√©s.</p>
      <div id="usersList" class="space-y-3 text-sm"></div>
    </section>

    <!-- Drawer -->
    <div id="drawer" class="hidden fixed inset-0 z-30">
      <div id="drawerBackdrop" class="absolute inset-0 bg-black/40"></div>
      <div class="absolute right-0 top-0 h-full w-full sm:w-[480px] bg-white/95 backdrop-blur shadow-2xl rounded-l-2xl flex flex-col">
        <div class="p-6 border-b flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur z-10">
          <h3 id="drawerTitle" class="text-lg font-semibold">Nouvelle intervention</h3>
          <button id="drawerClose" class="rounded-full w-8 h-8 grid place-items-center hover:bg-gray-100">‚úï</button>
        </div>
        <form id="taskForm" class="flex-1 overflow-y-auto p-6 grid gap-6">
          <input type="hidden" id="taskId" />
          <div>
            <label class="block text-sm text-[var(--text-dim)] mb-1">Titre</label>
            <input id="title" required class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500" />
          </div>
          <div>
            <label class="block text-sm text-[var(--text-dim)] mb-1">Description</label>
            <textarea id="description" rows="4" class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm text-[var(--text-dim)] mb-1">Service</label>
              <select id="team" class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500">
                <option>Technique</option><option>Menage</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-[var(--text-dim)] mb-1">Priorit√©</label>
              <select id="priority" class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500">
                <option>Normale</option><option>Haute</option><option>Urgent</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm text-[var(--text-dim)] mb-1">√âch√©ance</label>
              <input id="dueDate" type="date" class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500" />
            </div>
            <div>
              <label class="block text-sm text-[var(--text-dim)] mb-1">Statut</label>
              <select id="status" class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500">
                <option>A_faire</option><option>En_cours</option><option>Bloque</option><option>Termine</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm text-[var(--text-dim)] mb-1">Attribuer √† (optionnel)</label>
            <input id="assignee" placeholder="Nom du salari√©" class="w-full rounded-xl border border-[var(--line)] px-4 py-3 focus:ring-2 focus:ring-primary-300 focus:border-primary-500" />
          </div>
          <div class="flex items-center gap-4">
            <button class="px-6 py-3 rounded-xl bg-primary-600 text-white font-semibold hover:bg-primary-700 shadow-md">Enregistrer</button>
            <button type="button" id="deleteBtn" class="hidden px-6 py-3 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 shadow-md">Supprimer</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Firebase + App JS -->
  <script type="module">
    // --- Config Firebase (inchang√©)
    const firebaseConfig = {
      apiKey: "AIzaSyB0mHA_vMsBiCdzWDACfN4Lhef644NOHDY",
      authDomain: "dashboardcampinglaplagev3.firebaseapp.com",
      projectId: "dashboardcampinglaplagev3",
      storageBucket: "dashboardcampinglaplagev3.firebasestorage.app",
      messagingSenderId: "1083060495264",
      appId: "1:1083060495264:web:03e34965179a671ca6fac5"
    };
    if (firebaseConfig.apiKey === 'CHANGE_ME') document.getElementById('envBadge').classList.remove('hidden');

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- Helpers DOM
    const $ = (id) => document.getElementById(id);
    const authView = $('authView'), appView=$('appView'), userRoleEl=$('userRole');
    const logoutBtn=$('logoutBtn'), newTaskBtn=$('newTaskBtn'), board=$('board');
    const teamFilter=$('teamFilter'), statusFilter=$('statusFilter'), searchInput=$('searchInput');
    const drawer=$('drawer'), drawerBackdrop=$('drawerBackdrop'), drawerClose=$('drawerClose'), drawerTitle=$('drawerTitle');
    const taskForm=$('taskForm'), deleteBtn=$('deleteBtn');
    const tabs=$('tabs'), accountsView=$('accountsView'), usersList=$('usersList'), googleBtn=$('googleBtn');
    const authError=$('authError');
    const serviceBar=document.getElementById('serviceBar');
    const serviceHint=document.getElementById('serviceHint');
    const serviceHintLabel=document.getElementById('serviceHintLabel');

    let currentRole='Employe';
    let currentService='ALL'; // "Technique" | "Menage" | "ALL"

    // Tabs
    function showTab(key){
      if (tabs.classList.contains('hidden')) return;
      const taskActive = key === 'tasks';
      appView.querySelector('#accountsView').classList.toggle('hidden', taskActive);
      appView.querySelector('#boardWrapper').classList.toggle('hidden', !taskActive);
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        const active = btn.dataset.tab === key;
        btn.classList.toggle('bg-white', active);
        btn.classList.toggle('shadow', active);
        btn.classList.toggle('text-gray-600', !active);
      });
    }
    document.addEventListener('click',(e)=>{ const b=e.target.closest('.tab-btn'); if(b) showTab(b.dataset.tab); });

    // Status cols
    const statusColumns = [
      { key: 'A_faire',  title: '√Ä faire' },
      { key: 'En_cours', title: 'En cours' },
      { key: 'Bloque',   title: 'Bloqu√©' },
      { key: 'Termine',  title: 'Termin√©' },
    ];
    const prBar = (p) => p==='Urgent' ? 'bar-urgent' : (p==='Haute'? 'bar-haute':'bar-normale');
    const prPill = (p) => p==='Urgent' ? 'pill red' : (p==='Haute'? 'pill amber':'pill gray');

    const esc = (s='') => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const fdate = (iso)=>{ try{ return new Date(iso).toLocaleDateString('fr-FR'); }catch{ return iso; } };

    // Toast
    const toastRoot = document.getElementById('toastRoot');
    function showToast(type,msg,ms=2600){ const el=document.createElement('div'); el.className='toast'+(type==='error'?' err':''); el.innerHTML=(type==='success'?'‚úÖ ':'‚ö†Ô∏è ')+esc(msg); toastRoot.appendChild(el); setTimeout(()=>el.remove(),ms); el.onclick=()=>el.remove(); }

    // Skeleton
    let firstLoad = true;
    function renderSkeleton(){
      board.innerHTML='';
      for(let i=0;i<4;i++){
        const col=document.createElement('div'); col.className='board-col';
        col.innerHTML=`
          <div class="col-head">
            <div class="col-title">Chargement‚Ä¶</div>
            <span class="col-count">‚Äî</span>
          </div>
          <div class="grid gap-3">
            <div class="empty">‚Ä¶</div>
          </div>`;
        board.appendChild(col);
      }
    }

function renderBoard(tasks){
  board.innerHTML='';
  const isMobile = window.matchMedia('(max-width: 767px)').matches;
  let first = true;

  for(const col of statusColumns){
    const colEl = document.createElement('section');
    colEl.className = 'board-col ' + (isMobile ? 'mobile-col' : '');

    const filtered = tasks.filter(t=>t.status===col.key);

    // t√™te (bouton en mobile)
    const head = document.createElement(isMobile ? 'div' : 'div');
    head.className = 'col-head';

    if(isMobile){
      head.innerHTML = `
        <button type="button" class="px-2">
          <span class="col-title">${col.title}</span>
          <span class="col-count">${filtered.length}</span>
        </button>
      `;
    }else{
      head.innerHTML = `
        <div class="col-title">${col.title}</div>
        <span class="col-count">${filtered.length}</span>
      `;
    }

    // corps
    const body = document.createElement('div');
    body.className = (isMobile ? 'col-body ' : '') + 'grid gap-3';

    if(!filtered.length){
      body.innerHTML = `<div class="empty">Aucune intervention</div>`;
    }else{
      for(const t of filtered){
        const card = document.createElement('div');
        card.className = `task-card ${prBar(t.priority)} cursor-pointer`;
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="task-title truncate">${esc(t.title)}</div>
              <div class="task-meta truncate">${t.team}${t.assignee ? ' ¬∑ '+esc(t.assignee) : ''}</div>
            </div>
            <span class="${prPill(t.priority)} whitespace-nowrap">${t.priority || 'Normale'}</span>
          </div>
          ${t.dueDate ? `<div class="text-xs mt-3 text-gray-600">üóìÔ∏è ${fdate(t.dueDate)}</div>` : ''}
        `;
        card.addEventListener('click',()=>openDrawer(t));
        body.appendChild(card);
      }
    }

    colEl.appendChild(head);
    colEl.appendChild(body);

    // comportement accord√©on en mobile
    if(isMobile){
      if(first){ colEl.classList.add('open'); first=false; }
      head.querySelector('button').addEventListener('click', ()=>{
        // ferme les autres
        document.querySelectorAll('.mobile-col.open').forEach(el=>{ if(el!==colEl) el.classList.remove('open'); });
        colEl.classList.toggle('open');
      });
    }

    board.appendChild(colEl);
  }
}


    function openDrawer(task=null){
      drawer.classList.remove('hidden');
      if(task){
        drawerTitle.textContent='Modifier l\'intervention';
        $('taskId').value=task.id;
        $('title').value=task.title||''; $('description').value=task.description||'';
        $('team').value=task.team||'Technique'; $('priority').value=task.priority||'Normale';
        $('dueDate').value=task.dueDate||''; $('status').value=task.status||'A_faire'; $('assignee').value=task.assignee||'';
        deleteBtn.classList.remove('hidden');
        deleteBtn.onclick=async()=>{
          if(!confirm('Supprimer cette intervention ?')) return;
          await deleteDoc(doc(db,'tasks',task.id));
          showToast('success','Intervention supprim√©e'); closeDrawer();
        };
      }else{
        drawerTitle.textContent='Nouvelle intervention'; taskForm.reset(); $('taskId').value=''; $('status').value='A_faire'; deleteBtn.classList.add('hidden');
        // Si on est sur une page de service, pr√©-s√©lectionne
        if(currentService!== 'ALL'){ $('team').value=currentService; }
      }
      // Si r√¥le = Technique/M√©nage, verrouille le service
      const isServiceRole = (currentRole==='Technique' || currentRole==='Menage');
      $('team').disabled = isServiceRole;
    }
    const closeDrawer=()=>drawer.classList.add('hidden');
    drawerBackdrop.onclick=closeDrawer; drawerClose.onclick=closeDrawer;

    // Auth helpers
    async function ensureUserDoc(user){
      try{
        const uref=doc(db,'users',user.uid); const snap=await getDoc(uref);
        if(!snap.exists()) await setDoc(uref,{ role:'Employe', email:user.email||null, createdAt:serverTimestamp() });
      }catch(e){ console.warn(e); }
    }
    const provider=new GoogleAuthProvider();

    $('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); authError.textContent='';
      try{ await signInWithEmailAndPassword(auth, $('email').value.trim(), $('password').value.trim()); }
      catch(err){ authError.textContent='Connexion impossible'; showToast('error', err?.message || err); }
    });
    googleBtn.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }catch(e){ showToast('error','Connexion Google impossible : '+(e?.message||e)); }
    });
    logoutBtn.onclick=()=>signOut(auth);

    async function getUserRole(uid){
      try{ const s=await getDoc(doc(db,'users',uid)); return s.exists() ? (s.data().role||'Employe') : 'Employe'; }
      catch{ return 'Employe'; }
    }

    // Data listeners
    let unsubTasks=null;
    function attachTaskListener(){
      if(unsubTasks) unsubTasks();
      if(firstLoad) renderSkeleton();
      const tasksRef=collection(db,'tasks');
      unsubTasks=onSnapshot(query(tasksRef, orderBy('createdAt','desc')), (snap)=>{
        firstLoad=false;
        const q=(searchInput.value||'').toLowerCase();
        // Verrouillage par page de service et par r√¥le
        const serviceScope = deriveServiceScope();
        const sf=statusFilter.value;
        const items=[];
        snap.forEach(d=>{
          const t={ id:d.id, ...d.data() };
          // 1) Filtre service
          if(serviceScope!== 'ALL' && t.team!==serviceScope) return;
          // 2) Filtre manuel si admin a mis un teamFilter pr√©cis sur page "Affectations"
          const manualTeam = teamFilter.value;
          if(currentRoleHasServiceBar() && location.hash==="#affectations" && manualTeam!=='ALL' && t.team!==manualTeam) return;
          // 3) Statut
          if(sf==='ACTIVE' && ['Termine'].includes(t.status)) return;
          if(['A_faire','En_cours','Bloque','Termine'].includes(sf) && t.status!==sf) return;
          // 4) Recherche
          const blob=`${t.title} ${t.description} ${t.assignee}`.toLowerCase();
          if(q && !blob.includes(q)) return;
          items.push(t);
        });
        renderBoard(items);
        try{
  const counts = {A_faire:0, En_cours:0, Bloque:0, Termine:0};
  items.forEach(t=>counts[t.status] = (counts[t.status]||0)+1);
  document.title = `Interventions ‚Äì ${counts.A_faire + counts.En_cours} actives`;
}catch{}

      });
      // Astuce UI: afficher l'√©tiquette de la page courante
      if(deriveServiceScope()!== 'ALL'){
        serviceHint.classList.remove('hidden');
        serviceHintLabel.textContent = deriveServiceScope()==='Menage' ? 'Page M√©nage' : 'Page Technique';
      }else{
        serviceHint.classList.toggle('hidden', !(currentRoleHasServiceBar() && location.hash==="#affectations"));
        serviceHintLabel.textContent = 'Affectations (toutes)';
      }
    }

    // Users admin
    let unsubUsers=null;
    function startUsersListener(){
      if(unsubUsers) unsubUsers();
      unsubUsers=onSnapshot(collection(db,'users'), (snap)=>{
        usersList.innerHTML='';
        snap.forEach(d=>{
          const u={ id:d.id, ...d.data() };
          const row=document.createElement('div');
          row.className='flex items-center justify-between border rounded-xl p-3 bg-[var(--muted)]';
          row.innerHTML=`
            <div class="truncate max-w-[60vw]">
              <div class="font-medium text-gray-900 truncate">${u.email || u.id}</div>
              <div class="text-[11px] text-[var(--text-dim)] select-none">UID: ${u.id}</div>
            </div>
            <div class="flex items-center gap-3">
              <select class="px-3 py-2 rounded border border-[var(--line)] font-medium focus:ring-2 focus:ring-primary-300 focus:border-primary-500">
                <option ${u.role==='Employe'?'selected':''}>Employe</option>
                <option ${u.role==='Menage'?'selected':''}>Menage</option>
                <option ${u.role==='Technique'?'selected':''}>Technique</option>
                <option ${u.role==='Reception'?'selected':''}>Reception</option>
                <option ${u.role==='Responsable'?'selected':''}>Responsable</option>
              </select>
              <button class="px-4 py-2 rounded-xl bg-primary-600 text-white font-semibold hover:bg-primary-700">Enregistrer</button>
            </div>`;
          const select=row.querySelector('select'), save=row.querySelector('button');
          save.onclick=async()=>{
            try{ await updateDoc(doc(db,'users',u.id), { role: select.value, updatedAt: serverTimestamp() }); showToast('success','R√¥le enregistr√©'); }
            catch(e){ showToast('error','Maj r√¥le impossible : '+(e?.message||e)); }
          };
          usersList.appendChild(row);
        });
      });
    }

    // Service bar helpers
    function currentRoleHasServiceBar(){
      return (currentRole==='Reception' || currentRole==='Responsable');
    }
    function deriveServiceFromHash(){
      const h = location.hash.replace('#','');
      if(h==='technique') return 'Technique';
      if(h==='menage') return 'Menage';
      return 'ALL'; // affectations
    }
    function deriveServiceScope(){
      // Pages s√©par√©es pour Technique/M√©nage -> forcer leur service
      if(currentRole==='Technique') return 'Technique';
      if(currentRole==='Menage') return 'Menage';
      // Sinon, d√©pend de l'onglet URL choisi par Reception/Responsable
      return currentService;
    }
    function applyServiceUI(){
      const scope = deriveServiceScope();
      // Barre de service visible uniquement pour Reception/Responsable
      serviceBar.classList.toggle('hidden', !currentRoleHasServiceBar());
      // Sur pages de service, masquer le select service global (teamFilter)
      const isScoped = scope!=='ALL';
      teamFilter.parentElement.classList.toggle('hidden', isScoped);
      // Boutons actifs
      document.querySelectorAll('.svc-btn').forEach(a=>{
        const svc = a.getAttribute('data-service');
        const active = (location.hash==='#affectations' && svc==='ALL') || (svc===scope);
        a.classList.toggle('bg-primary-600', active);
        a.classList.toggle('text-white', active);
        a.classList.toggle('border-primary-600', active);
      });
      // Bouton "nouvelle" visible seulement pour Reception/Responsable
      newTaskBtn.classList.toggle('hidden', !(currentRole==='Reception' || currentRole==='Responsable'));
    }

    // Filters
    [teamFilter, statusFilter].forEach(el=>el.addEventListener('change', attachTaskListener));
    searchInput.addEventListener('input', attachTaskListener);

    newTaskBtn.onclick=()=>openDrawer();
    const fabNew = document.getElementById('fabNew');
if(fabNew){ fabNew.addEventListener('click', () => openDrawer()); }

    $('drawer').addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    taskForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload={
        title:$('title').value.trim(), description:$('description').value.trim(),
        team:$('team').value, priority:$('priority').value, dueDate:$('dueDate').value||null,
        status:$('status').value, assignee:$('assignee').value.trim()||null, updatedAt: serverTimestamp(),
      };
      try{
        const id=$('taskId').value;
        if(id){ await updateDoc(doc(db,'tasks',id), payload); }
        else  { await addDoc(collection(db,'tasks'), { ...payload, createdAt: serverTimestamp(), createdBy: auth.currentUser.uid }); }
        showToast('success','Intervention enregistr√©e'); closeDrawer();
      }catch(err){ showToast('error','Erreur enregistrement : '+(err?.message||err)); }
    });

    // Routing par hash pour pages s√©par√©es
    window.addEventListener('hashchange', ()=>{
      if(currentRoleHasServiceBar()){
        const svc = deriveServiceFromHash();
        currentService = svc;
      }
      applyServiceUI();
      attachTaskListener();
    });

    // Auth state
onAuthStateChanged(auth, async (user)=>{
  const header = document.getElementById('headerRoot') || document.querySelector('header.topbar'); // NEW

  if(user){
    await ensureUserDoc(user);
    currentRole = await getUserRole(user.uid);
    userRoleEl.classList.remove('hidden');
    userRoleEl.querySelector('strong').textContent=currentRole;

    // afficher l'app + header
    authView.classList.add('hidden');
    appView.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    $('tabs').classList.remove('hidden');
    header?.classList.remove('hidden'); // NEW

    accountsView.classList.toggle('hidden', currentRole!=='Responsable');
    if(currentRole==='Responsable') startUsersListener();

    // D√©terminer la page/service initial
    if(currentRole==='Technique'){ location.hash = '#technique'; }
    else if(currentRole==='Menage'){ location.hash = '#menage'; }
    else { // Reception / Responsable / Employe
      const svc = deriveServiceFromHash();
      currentService = svc; // respecte l'URL partag√©e
    }
    applyServiceUI();
    attachTaskListener();
    showTab('tasks');
  }else{
    if(unsubTasks) unsubTasks();
    if(unsubUsers) unsubUsers();

    // montrer uniquement la page de connexion + cacher header
    authView.classList.remove('hidden');
    appView.classList.add('hidden');
    accountsView.classList.add('hidden');
    userRoleEl.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    tabs.classList.add('hidden');
    header?.classList.add('hidden'); // NEW
  }
});

  </script>
</body>
</html>

